{{ define "content" }}

<div class="p-3">
    <div class="flex justify-start">
        <span id="user-profile" class="flex py-1 pr-6 pl-3 items-center bg-green-100 text-green-700 border border-green-200 rounded-lg">
            <img id="user-image" alt="User Image" class="border border-2" style="display:none;" />
            <span id="display-name" class="text-green-700">
                Loading Profile
                <span class="user-profile-loading-dots"></span>
            </span>
        </span>

        <span id="exporter-controls">
            <span id="export-count">0</span>
            <a href="#" id="prepare-btn" class="ml-3 mr-2">Prepare</a>
        </span>
    </div>

    <div id="playlists"></div>
</div>

<style>
    span#user-profile {
        max-width: fit-content;
    }
    img#user-image {
        border-radius: 100%;
        width: 2.1em;
        height: 2.1em;
        border-color: rgba(0,0,0,0.2);
    }
    span#display-name {
        margin-left: .9em;
    }

    div#playlists {
        padding: 10px 0;
    }
</style>

<script>
    class Api {
        static async getUserProfile() {
            const res = await fetch('/user-profile');
            if (res.status !== 200) {
                return null;
            }

            return await res.json()
        }

        static async getAllPlaylists() {
            const res = await fetch('/playlists');
            if (res.status !== 200) {
                return null;
            }

            return await res.json();
        }

        /**
         * @param playlistId string
         */
        static async getTracksInPlaylist(playlistId) {
            let endpoint = '/playlist/tracks';

            endpoint += `?playlistId=${playlistId}`;

            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                },
                body: JSON.stringify({playlistId}),
            });

            if (res.status !== 200) {
                return null;
            }

            return await res.json();
        }
    }

    class UserProfile {
        elements = {
            displayName: document.querySelector("#display-name"),
            image: document.querySelector("#user-image"),
        }

        async init() {
            new LoadingDots('.user-profile-loading-dots');

            const userProfile = await Api.getUserProfile();
            if (!userProfile) {
                return;
            }

            this.injectProfile(userProfile);
        }

        injectProfile(userProfile) {
            this.elements.displayName.innerHTML = userProfile.display_name;

            if (!userProfile.images.length) {
                this.elements.image.style.display = 'none';
                return
            }
            this.elements.image.src = userProfile.images[0].url;
            this.elements.image.style.display = 'inline-block';
        }
    }

    class Playlists {
        /**
         * @type PlaylistExporter
         */
        playlistExporter = undefined;

        elements = {
            listContainer: document.querySelector('div#playlists'),
        }

        /**
         * @param playlistExporter PlaylistExporter
         */
        setPlaylistExporter(playlistExporter) {
            this.playlistExporter = playlistExporter;
        }

        async init() {
            const playlists = await Api.getAllPlaylists();
            if (! playlists) {
                return;
            }

            this.injectPlaylists(playlists.items);
        }

        /**
         * @param playlists array
         */
        injectPlaylists(playlists) {
            for (let playlist of playlists) {
                const element = this.createPlaylistElement(playlist)
                this.elements.listContainer.appendChild(element);
                element.addEventListener('click', e => {this.handlePlaylistClick(e)});
            }
        }

        /**
         * @param playlist object
         * @returns {HTMLDivElement}
         */
        createPlaylistElement(playlist) {
            const element = document.createElement('div');
            element.classList.add('playlist-item');
            element.setAttribute('data-playlist-id', playlist.id);
            element.innerHTML = `
            <span>${playlist.name}</span>
            <a href="#" class="download-btn">Download</a>
            `;
            return element;
        }

        handlePlaylistClick(e) {
            const
                ct = e.currentTarget,
                playlistId = ct.getAttribute('data-playlist-id');

            if (! playlistId) {
                return;
            }

            this.playlistExporter.toggleSelectedPlaylist(playlistId);
        }

        /**
         * @param playlistId string
         */
        indicateSelectedPlaylist(playlistId) {
            this.getPlaylistItemById(playlistId).classList.add('chosen-for-export');
        }

        /**
         * @param playlistId string
         */
        indicateNotSelectedPlaylist(playlistId) {
            this.getPlaylistItemById(playlistId).classList.remove('chosen-for-export');
        }

        /**
         * @param playlistId string
         */
        getPlaylistItemById(playlistId) {
            return this.elements.listContainer.querySelector(`.playlist-item[data-playlist-id="${playlistId}"]`)
        }

        /**
         * @returns {NodeListOf<Element>}
         */
        getAllPlaylistItems() {
            return this.elements.listContainer.querySelectorAll('.playlist-item');
        }

        /**
         * @returns {NodeListOf<Element>}
         */
        getSelectedPlaylistItems() {
            return this.elements.listContainer.querySelectorAll('.playlist-item.chosen-for-export');
        }

        removePreparedIndicationFromAll() {
            this.getAllPlaylistItems().forEach(el => {
                el.classList.remove('ready-for-download');
            });
        }

        /**
         * @param playlistId string
         */
        indicatePrepared(playlistId) {
            this.getPlaylistItemById(playlistId).classList.add('ready-for-download');
        }
    }

    class PlaylistExporter {
        /**
         * @type Playlists
         */
        playlistsManager = undefined;
        /**
         * @type PlaylistExportControlsManager
         */
        playlistsExportControlsManager = undefined;

        selected = {};

        preparedExports = {};

        /**
         * @param playlistsManager Playlists
         */
        setPlaylistManager(playlistsManager) {
            this.playlistsManager = playlistsManager;
        }

        /**
         * @param playlistExportControlsManager PlaylistExportControlsManager
         */
        setPlaylistExportControlsManager(playlistExportControlsManager) {
            this.playlistsExportControlsManager = playlistExportControlsManager;
        }

        /**
         * @param playlistId string
         */
        toggleSelectedPlaylist(playlistId) {
            if (this.selected.hasOwnProperty(playlistId)) {
                delete this.selected[playlistId];
                this.playlistsManager.indicateNotSelectedPlaylist(playlistId);
                this.playlistsExportControlsManager.updateCount(Object.keys(this.selected).length);
                return;
            }

            this.selected[playlistId] = undefined;
            this.playlistsManager.indicateSelectedPlaylist(playlistId);
            this.playlistsExportControlsManager.updateCount(Object.keys(this.selected).length);
        }

        /**
         * @return []string
         */
        getIdsOfAllSelectedPlaylists() {
            const playlistItemElements = this.playlistsManager.getSelectedPlaylistItems();
            const ids = [];

            playlistItemElements.forEach(item => {
                ids.push(item.getAttribute('data-playlist-id'));
            });

            return ids;
        }

        /**
         * @param playlistIds []string
         */
        async prepareExports(playlistIds) {
            this.preparedExports = {};
            this.playlistsManager.removePreparedIndicationFromAll();
            await this.#loadTracksForEachPlaylist(playlistIds);
        }

        /**
         * @param playlistIds []string
         */
        async #loadTracksForEachPlaylist(playlistIds) {
            for (let id of playlistIds) {
                const tracks = await Api.getTracksInPlaylist(id);

                this.preparedExports[id] = tracks;

                this.playlistsManager.indicatePrepared(id);
            }
        }
    }

    class PlaylistExportControlsManager {
        /**
         * @type PlaylistExporter
         */
        playlistExporter = undefined;

        elements = {
            container: undefined,
            selectedCount: undefined,
            prepareBtn: undefined,
        }

        constructor() {
            this.elements.container = document.querySelector('#exporter-controls');
            this.elements.selectedCount = this.elements.container.querySelector('#export-count');
            this.elements.prepareBtn = this.elements.container.querySelector('#prepare-btn');

            this.elements.prepareBtn.addEventListener('click', e => {
                this.handlePrepareClick(e)
            });
        }

        /**
         * @param exporter PlaylistExporter
         */
        setPlaylistExporter(exporter) {
            this.playlistExporter = exporter;
        }

        /**
         * @param count int
         */
        updateCount(count) {
            this.elements.selectedCount.innerHTML = count;
        }

        handlePrepareClick(e) {
            const playlistIds = this.playlistExporter.getIdsOfAllSelectedPlaylists();
            this.playlistExporter.prepareExports(playlistIds);
        }
    }

    class PageManager {
        /**
         * @type UserProfile
         */
        userProfile = undefined;
        /**
         * @type Playlists
         */
        playlists = undefined;
        /**
         * @type PlaylistExporter
         */
        playlistExporter = undefined;
        /**
         * @type PlaylistExportControlsManager
         */
        playlistExportControlsManager = undefined;

        constructor() {
            this.playlistExporter = new PlaylistExporter();
            this.userProfile = new UserProfile();
            this.userProfile.init();
            this.playlists = new Playlists();
            this.playlists.init();
            this.playlistExportControlsManager = new PlaylistExportControlsManager();
            this.playlistExportControlsManager.setPlaylistExporter(this.playlistExporter);
            this.playlists.setPlaylistExporter(this.playlistExporter);
            this.playlistExporter.setPlaylistManager(this.playlists);
            this.playlistExporter.setPlaylistExportControlsManager(this.playlistExportControlsManager)
        }
    }

    new PageManager();
</script>

{{ end }}
