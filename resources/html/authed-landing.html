{{ define "content" }}

<div class="p-3">
    <span id="user-profile" class="flex py-1 pr-6 pl-3 items-center bg-green-100 text-green-700 rounded-lg">
        <img id="user-image" alt="User Image" class="border border-2" style="display:none;" />
        <span id="display-name" class="text-green-700">
            Loading Profile
            <span class="user-profile-loading-dots"></span>
        </span>
    </span>

    <div id="playlists"></div>
</div>

<style>
    span#user-profile {
        max-width: fit-content;
    }
    img#user-image {
        border-radius: 100%;
        width: 2.1em;
        height: 2.1em;
        border-color: rgba(0,0,0,0.13)
    }
    span#display-name {
        margin-left: .9em;
    }

    div#playlists {
        padding: 10px 0;
    }
</style>

<script>
    class Api {
        static async getUserProfile() {
            const res = await fetch('/user-profile');
            if (res.status !== 200) {
                return null;
            }

            return await res.json()
        }

        static async getAllPlaylists() {
            const res = await fetch('/playlists');
            if (res.status !== 200) {
                return null;
            }

            return await res.json();
        }
    }

    class UserProfile {
        elements = {
            displayName: document.querySelector("#display-name"),
            image: document.querySelector("#user-image"),
        }

        async init() {
            new LoadingDots('.user-profile-loading-dots');

            const userProfile = await Api.getUserProfile();
            if (!userProfile) {
                return;
            }

            this.injectProfile(userProfile);
        }

        injectProfile(userProfile) {
            this.elements.displayName.innerHTML = userProfile.display_name;

            if (!userProfile.images.length) {
                this.elements.image.style.display = 'none';
                return
            }
            this.elements.image.src = userProfile.images[0].url;
            this.elements.image.style.display = 'inline-block';
        }
    }

    class Playlists {
        /**
         * @type PlaylistExporter
         */
        playlistExporter = undefined;

        elements = {
            listContainer: document.querySelector('div#playlists'),
        }

        /**
         * @param playlistExporter PlaylistExporter
         */
        setPlaylistExporter(playlistExporter) {
            this.playlistExporter = playlistExporter;
        }

        async init() {
            const playlists = await Api.getAllPlaylists();
            if (! playlists) {
                return;
            }

            this.injectPlaylists(playlists.items);
        }

        /**
         * @param playlists array
         */
        injectPlaylists(playlists) {
            for (let playlist of playlists) {
                const element = document.createElement('div');
                element.classList.add('playlist-item');
                element.setAttribute('data-playlist-id', playlist.id);
                element.innerHTML = playlist.name;
                this.elements.listContainer.appendChild(element);
                element.addEventListener('click', e => {this.handlePlaylistClick(e)});
            }
        }

        handlePlaylistClick(e) {
            const
                ct = e.currentTarget,
                playlistId = ct.getAttribute('data-playlist-id');

            if (! playlistId) {
                return;
            }

            this.playlistExporter.toggleSelectedPlaylist(playlistId);
        }

        /**
         * @param playlistId string
         */
        indicateSelectedPlaylist(playlistId) {
            this.getPlaylistItemById(playlistId).classList.add('chosen-for-export');
        }

        /**
         * @param playlistId string
         */
        indicateNotSelectedPlaylist(playlistId) {
            this.getPlaylistItemById(playlistId).classList.remove('chosen-for-export');
        }

        /**
         * @param playlistId string
         */
        getPlaylistItemById(playlistId) {
            return this.elements.listContainer.querySelector(`.playlist-item[data-playlist-id="${playlistId}"]`)
        }
    }

    class PlaylistExporter {
        /**
         * @type Playlists
         */
        playlistsManager = undefined;

        selected = {};

        /**
         * @param playlistsManager Playlists
         */
        setPlaylistManager(playlistsManager) {
            this.playlistsManager = playlistsManager;
        }

        /**
         * @param playlistId string
         */
        toggleSelectedPlaylist(playlistId) {
            if (this.selected.hasOwnProperty(playlistId)) {
                delete this.selected[playlistId];
                this.playlistsManager.indicateNotSelectedPlaylist(playlistId);
                return;
            }

            this.selected[playlistId] = undefined;
            this.playlistsManager.indicateSelectedPlaylist(playlistId);
        }
    }

    class PageManager {
        /**
         * @type UserProfile
         */
        userProfile = undefined;
        /**
         * @type Playlists
         */
        playlists = undefined;
        /**
         * @type PlaylistExporter
         */
        playlistExporter = undefined;

        constructor() {
            this.playlistExporter = new PlaylistExporter();
            this.userProfile = new UserProfile();
            this.userProfile.init();
            this.playlists = new Playlists();
            this.playlists.init();
            this.playlists.setPlaylistExporter(this.playlistExporter);
            this.playlistExporter.setPlaylistManager(this.playlists);
        }
    }

    new PageManager();
</script>

{{ end }}
